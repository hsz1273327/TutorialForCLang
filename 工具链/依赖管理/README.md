# 依赖管理

C/C++的依赖管理算是非常凌乱的,在前面的文章中我们也算是大致介绍了下使用cmake管理依赖的方式.很明显这个方式痛点不少,还是比较繁琐复杂的.一旦一个项目依赖上十几二十个库那维护起来还是很酸爽的.同时如果第三方库大量使用源码安装会大大拖慢编译时间,造成大量的资源浪费.依赖大量托管在git仓库,http服务器上也会对编译的可维护性造成一定影响,同时对代码安全有要求的场景这种方式也很难管理维护.

目前看C/C++中的依赖管理有如下几种模式:

+ 使用linux发行版包管理仓库,优点是每个发行版一般都会自带,免配置,免安装,用起来应该是最方便的,缺点也很明显,库是系统级的,出点问题就是系统出问题了
+ 使用类似[homebrew](https://docs.brew.sh/)的用户级包管理仓库,优点是用起来还算方便,虽然要安装但基本免配置,而且是用户级的,相对没有系统级的风险那么大.但仅支持macos和linux
+ `cmake`方案,源码级别的依赖管理,配置比较复杂,每层的安装都依赖于网络,但对系统的影响最小
+ `git submodule`方案,源码级别的依赖管理,完全依赖git,门槛和cmake方案差不多,但不如cmake方案灵活,对系统的影响也最小
+ `vcpkg`方案,微软搞出来的集中式包管理平台,优点类似针对项目的homebrew,优点是库多,缺点是依然是源码级别的依赖管理,
+ `conan`方案,纯开源实现的跨平台依赖管理工具,支持常用平台的二进制包分发,且提供了一个免费的官方集中式仓库.使用需要一定门槛.

我们期望的是可以有一个集中式的依赖仓库,类似pypi,它里面有大量常用库在各个常用平台上已经编译好的二进制包,同时也提供源码包以供在不常用的平台上也可以尝试安装.同时这个平台也提供一个客户端工具,类似pip,可以用于管理项目的依赖项,同时也支持将自己的库上传到仓库中统一管理,同时最好提供用户自行部署仓库的能力,以方便企业或者团体私人使用. C/C++有这样的工具么?答案是有,而且不止一个,但又不完全有.目前没有一个工具可以满足上面所有的期望,但又有两个候选的工具他们可以一定程度上满足上面的需求.他们就是`vcpkg`和`conan`,下面是它们以及各种linux发行版包管理工具对对比矩阵

| 特性\工具                        | linux发行版包管理仓库 | vcpkg | conan | homebrew      | `cmake`方案 | `vcpkg`方案 |
| -------------------------------- | --------------------- | ----- | ----- | ------------- | ----------- | ----------- |
| 集中式管理                       | 是                    | 是    | 是    | 是            | 否          | 是          |
| 跨平台                           | 否                    | 是    | 是    | 不支持windows | 是          | 是          |
| 常用平台提供二进制包             | 是                    | 否    | 是    | 是            | 否          | 否          |
| 保管库数量                       | 多                    | 多    | 少    | 多            | ---         | 多          |
| 支持自行部署仓库                 | 否                    | 否    | 是    | 否            | ---         | 否          |
| 客户端工具用于查找安装卸载依赖   | 是                    | 是    | 是    | 是            | ---         | 是          |
| 客户端工具可以安装指定版本的依赖 | 是                    | 否    | 是    | 是            | ---         | 是          |
| 客户端工具用于发布依赖           | 是                    | 是    | 是    | 是            | ---         | 是          |
| 客户端工具提供系统级依赖管理     | 是                    | 否    | 否    | 否            | ---         | 否          |
| 客户端工具提供项目级的依赖管理   | 否                    | 否    | 是    | 否            | 是          | 是          |
| 使用难度                         | 低                    | 中    | 高    | 低            | 高          | 中          |

看起来conan更有优势,但架不住conan上的资源太少.好在这两个工具都可以无缝的和cmake结合使用,这样相当于我们可以使用cmake来管理项目,而不同的依赖管理工具则专门用于管理项目依赖.

## 针对可执行文件的C/C++项目依赖管理策略

任何情况下我们都希望我们编译项目不会影响系统,因此项目级的依赖管理才是我们应该采取的策略.

C/C++项目的依赖管理可以遵从如下规则进行:

1. 尽可能使用`conan`管理项目依赖
2. `conan`中找不到的包尽量使用cmake的`FetchContent`模块从源码开始编译
3. `conan`中找不到的依赖,而且`FetchContent`获取困难时可以尝试使用`vcpkg`安装.
4. 尽量不用linux发行版包管理工具管理依赖

我们继续改造`helloworld_with_log`项目.这个项目依赖`spdlog`这个包而conan中刚好有.这里就借着这个项目介绍下如何使用conan构造可执行文件.
