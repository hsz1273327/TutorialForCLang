
# 制作小工具


在linux的世界里,很多工作都是由小工具完成的,它恐怕是现如今流行的`微服务`架构最早的实践了.

所谓小工具有这样的特点:

1. 从标准输入读取数据
2. 在标准输出显示数据
3. 处理文本数据，而不是难以阅读的二进制格式
4. 只做一件简单的事

通过标准输入输出可以方便的做重定向,而文本数据除了机器好读,人也好读.


所谓重新定向是指使用`>`,`>>`作为输出,使用`<`,`<<`作为输入


比较让人熟知的就是`grep`小工具了,它的作用是过滤掉文本中不含关键字的行.而一般我们都是拿他和其他工具配合使用的,比如我希望查看之前使用过的带`python`的历史记录,那就可以这样写:

```shell
history | grep python
```

当然了其他语言比如python也可以制作小工具,而且由于语法更加简单,抽象层次更高,实际上写起来会更加简单,但在这边用c/c++来做小工具有其合理的一面

1. 不用依赖环境

    c/c++不依赖于运行环境,只要编译通过了就可以运行二进制代码.而带有vm的语言比如java,python,脱离了vm就无法运行了
    
2. 高效

    多数情况下,,相同的逻辑,C/C++制作的工具有最高的运行效率
    
3. 小巧

    像go语言,也是编译成二进制后执行的语言,但由于其抽象层次更高,生成的代码比使用c/c++写的大得多,而c++如果使用模板的话也会比C写的大得多

## 从一个例子开始

我们来写一个gps数据格式转换工具,使用它我们可以将gps数据转化为符合规定的json格式,gps数据是形如:

```
42.363400,-71.098465,Speed = 21
42.363400,-71.097588,Speed = 23
42.363400,-71.098465,Speed = 27
.
.
.
```
的csv数据

而地图应用需要的格式则形如:

```json
data = [
{latitude: 42.363400, longitude: -71.098465, info: 'Speed = 21'},
.
.
.
]
```
的json数据



好,开始我们的小程序:


```python
%%writefile src/C9/geo2json.cpp
#include <stdio.h>

int main(){
    float latitude;
    float longitude;
    char info[80];
    int started = 0;
    puts("data=[");
    while (scanf("%f,%f,%79[^\n]",&latitude,&longitude,&info) == 3){
        if (started){
            printf(",\n");
        } else {
            started = 1;
        }
        printf("{latitude: %f, longitude: %f, info: '%s'}",latitude,longitude,info);
    }
    puts("\n]");
    return 0;
}
```

    Overwriting src/C9/geo2json.cpp



```python
!g++-7 -o bin/geo2json src/C9/geo2json.cpp
```


```python
!./bin/geo2json < source/gpsdata.csv > source/gpsdata.json
```


```python
!cat source/gpsdata.json
```

    data=[
    {latitude: 42.363400, longitude: -71.098465, info: 'Speed = 21'},
    {latitude: 42.363327, longitude: -71.097588, info: 'Speed = 23'},
    {latitude: 42.363255, longitude: -71.096710, info: 'Speed = 17'},
    {latitude: 42.363182, longitude: -71.095833, info: 'Speed = 22'},
    {latitude: 42.363110, longitude: -71.094955, info: 'Speed = 14'},
    {latitude: 42.363037, longitude: -71.094078, info: 'Speed = 16'},
    {latitude: 42.362965, longitude: -71.093201, info: 'Speed = 18'},
    {latitude: 42.362892, longitude: -71.092323, info: 'Speed = 22'},
    {latitude: 42.362820, longitude: -71.091446, info: 'Speed = 17'},
    {latitude: 42.362747, longitude: -71.090569, info: 'Speed = 23'},
    {latitude: 42.362675, longitude: -71.089691, info: 'Speed = 14'},
    {latitude: 42.362602, longitude: -71.088814, info: 'Speed = 19'},
    {latitude: 42.362530, longitude: -71.087936, info: 'Speed = 16'},
    {latitude: 42.362457, longitude: -71.087059, info: 'Speed = 16'},
    {latitude: 423.623840, longitude: -71.086182, info: 'Speed = 21'}
    ]


### 数据验证

不难发现,输入数据中有错误数据,我们的程序要加入一些验证逻辑来进行错误检验,当然了,错误信息应该输出在stderr里


```python
%%writefile src/C9/geo2json.cpp
#include <stdio.h>

int main(){
    float latitude;
    float longitude;
    char info[80];
    int started = 0;
    puts("data=[");
    while (scanf("%f,%f,%79[^\n]",&latitude,&longitude,&info) == 3){
        if (started){
            printf(",\n");
        } else {
            started = 1;
        }
        
        if ((latitude < -90.0) || (latitude > 90.0)) {
             fprintf(stderr,"Invalid latitude: %f\n", latitude);
             continue;
        }
        if ((longitude < -180.0) || (longitude > 180.0)) {
             fprintf(stderr, "Invalid longitude: %f\n", longitude);
             continue;
        }
        
        printf("{latitude: %f, longitude: %f, info: '%s'}",latitude,longitude,info);
    }
    puts("\n]");
    return 0;
}
```

    Overwriting src/C9/geo2json.cpp



```python
!g++-7 -o bin/geo2json src/C9/geo2json.cpp
```


```python
!./bin/geo2json < source/gpsdata.csv > source/gpsdata.json
```

    Invalid latitude: 423.623840



```python
!cat source/gpsdata.json
```

    data=[
    {latitude: 42.363400, longitude: -71.098465, info: 'Speed = 21'},
    {latitude: 42.363327, longitude: -71.097588, info: 'Speed = 23'},
    {latitude: 42.363255, longitude: -71.096710, info: 'Speed = 17'},
    {latitude: 42.363182, longitude: -71.095833, info: 'Speed = 22'},
    {latitude: 42.363110, longitude: -71.094955, info: 'Speed = 14'},
    {latitude: 42.363037, longitude: -71.094078, info: 'Speed = 16'},
    {latitude: 42.362965, longitude: -71.093201, info: 'Speed = 18'},
    {latitude: 42.362892, longitude: -71.092323, info: 'Speed = 22'},
    {latitude: 42.362820, longitude: -71.091446, info: 'Speed = 17'},
    {latitude: 42.362747, longitude: -71.090569, info: 'Speed = 23'},
    {latitude: 42.362675, longitude: -71.089691, info: 'Speed = 14'},
    {latitude: 42.362602, longitude: -71.088814, info: 'Speed = 19'},
    {latitude: 42.362530, longitude: -71.087936, info: 'Speed = 16'},
    {latitude: 42.362457, longitude: -71.087059, info: 'Speed = 16'},
    
    ]

